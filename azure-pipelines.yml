trigger:
- main   # or your default branch

# Use your self-hosted agent pool
pool:
  name: 'Default'   # replace with the pool name where your agent is registered

variables:
  azureServiceConnection: 'AzureBootcampConnection'   # service connection name from Project Settings
  appServiceName: 'bootcamp-cicd-demo-app'            # your App Service name

stages:
# -------------------
# 1. Build Stage
# -------------------
- stage: Build
  displayName: 'Build and Package'
  jobs:
  - job: BuildJob
    displayName: 'Build Job'
    pool:
      name: 'Default'
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'
      displayName: 'Install Node.js'

    - script: |
        npm install
      displayName: 'Install npm packages'

    - script: |
        npm test
      displayName: 'Run tests'

    - task: ArchiveFiles@2
      inputs:
        rootFolderOrFile: '$(Build.SourcesDirectory)'
        includeRootFolder: false
        archiveFile: '$(Build.ArtifactStagingDirectory)/app.zip'
        replaceExistingArchive: true
      displayName: 'Archive app files'

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/app.zip'
        ArtifactName: 'drop'
        publishLocation: 'Container'
      displayName: 'Publish build artifact'

# -------------------
# 2. Deploy Stage
# -------------------
- stage: Deploy
  displayName: 'Deploy to Azure App Service'
  dependsOn: Build
  jobs:
  - job: DeployJob
    displayName: 'Deploy Job'
    pool:
      name: 'Default'
    steps:
    - task: DownloadPipelineArtifact@2
      inputs:
        artifactName: 'drop'
        path: '$(System.DefaultWorkingDirectory)'
      displayName: 'Download build artifact'

    - task: AzureWebApp@1
      inputs:
        azureSubscription: '$(azureServiceConnection)'   # must match your service connection name
        appName: '$(appServiceName)'                     # must match your App Service name
        package: '$(System.DefaultWorkingDirectory)/drop/app.zip'
      displayName: 'Deploy to Azure App Service'
